<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Informations de s√©jour</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background:#0b0d12; color:#eef1f6; display:flex; min-height:100dvh; }
    .wrap { margin:auto; width:min(720px, 92vw); padding: 20px; }
    .card { background:#121722; border:1px solid #222938; border-radius:16px; padding:24px; box-shadow: 0 8px 24px rgba(0,0,0,.25); margin-bottom: 20px; }
    h1 { font-size:clamp(22px, 3.5vw, 28px); margin:0 0 16px; }
    h2 { font-size: 20px; margin: 20px 0 10px; color: #3e7aff; }
    p { margin: 8px 0; line-height: 1.6; }
    strong { color: #fff; }
    .copy-btn { 
      background: #3e7aff; 
      color: white; 
      border: none; 
      padding: 6px 12px;
      border-radius: 8px; 
      font-size: 14px; 
      cursor: pointer;
      margin-left: 10px;
    }
    .copy-btn:hover { background: #2d5fd9; }
    .copy-btn:active { transform: translateY(1px); }
    .error { color:#ff7b7b; padding: 20px; text-align: center; }
    .loading { color:#3e7aff; padding: 20px; text-align: center; }
    pre { 
      background: #0e121a; 
      padding: 16px; 
      border-radius: 8px; 
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <div id="content">
      <div class="loading">
        <p>‚è≥ ...</p>
      </div>
    </div>
  </main>

  <script>
    const dict_language = {
      'Informations Importantes' : {
        'fr': 'Informations Importantes',
        'en': 'Important Information',
        'es': 'Informaci√≥n Importante',
        'it': 'Informazioni Importanti',
        'ru': '–í–∞–∂–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'
      },
      'Codes d\'Acc√®s' : {
        'fr': 'Codes d\'Acc√®s',
        'en': 'Access Codes',
        'es': 'C√≥digos de Acceso',
        'it': 'Codici di Accesso',
        'ru': '–ö–æ–¥—ã –¥–æ—Å—Ç—É–ø–∞'
      },
      'Code Immeuble' : {
        'fr': 'Code Immeuble',
        'en': 'Building Code',
        'es': 'C√≥digo del Edificio',
        'it': 'Codice Edificio',
        'ru': '–ö–æ–¥ –∑–¥–∞–Ω–∏—è'
      },
      'Code Appartement' : {
        'fr': 'Code Appartement',
        'en': 'Apartment Code',
        'es': 'C√≥digo del Apartamento',
        'it': 'Codice Appartamento',
        'ru': '–ö–æ–¥ –∫–≤–∞—Ä—Ç–∏—Ä—ã'
      },
      'Connexion WiFi' : {
        'fr': 'Connexion WiFi',
        'en': 'WiFi Connection',
        'es': 'Conexi√≥n WiFi',
        'it': 'Connessione WiFi',
        'ru': '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ WiFi'
      },
      'R√©seau' : {
        'fr': 'R√©seau',
        'en': 'Network',
        'es': 'Red',
        'it': 'Rete',
        'ru': '–°–µ—Ç—å'
      },
      'Mot de Passe' : {
        'fr': 'Mot de Passe',
        'en': 'Password',
        'es': 'Contrase√±a',
        'it': 'Password',
        'ru': '–ü–∞—Ä–æ–ª—å'
      },
      'Messages Complets' : {
        'fr': 'Messages Complets',
        'en': 'Full Messages',
        'es': 'Mensajes Completos',
        'it': 'Messaggi Completi',
        'ru': '–ü–æ–ª–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è'
      },
      'Erreur lors du chargement' : {
        'fr': 'Erreur lors du chargement',
        'en': 'Error loading',
        'es': 'Error al cargar',
        'it': 'Errore durante il caricamento',
        'ru': '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ'
      }
    };

    function getCode() {
      const urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get("code");
      if (!code) {
        const pathMatch = window.location.pathname.match(/\/i\/([a-zA-Z0-9]{4,5})/);
        if (pathMatch) {
          code = pathMatch[1];
        }
      }
      
      return code || "";
    }

    async function main() {
      const code = getCode();
      const contentDiv = document.getElementById("content");
      
      if (!code) {
        contentDiv.innerHTML = '<div class="error"><p>‚ùå ERROR</p></div>';
        return;
      }

      try {
        const resp = await fetch(`/api/get-link?code=${encodeURIComponent(code)}`);
        
        if (!resp.ok) {
          contentDiv.innerHTML = '<div class="error"><p>‚ùå ERROR</p></div>';
          return;
        }

        const data = await resp.json();

        const digicodeImmeuble = data.digicodeImmeuble || "‚ùå";
        const digicodeAppartement = data.digicodeAppartement || "‚ùå";
        const wifi = data.wifi || "‚ùå";
        const wifiPass = data.wifiPass || "‚ùå";
        const message = data.message || "";
        const language = data.language || "fr";

        contentDiv.innerHTML = `
          <div class="card">
            <h1>üìã ${dict_language['Informations Importantes'][language]}</h1>
            <div id="importantCodes">
              <h2>üîê ${dict_language["Codes d\'Acc√®s"][language]}</h2>
              <p>üè¢ <strong>${dict_language["Code Immeuble"][language]} :</strong> ${digicodeImmeuble}</p>
              <p>üö™ <strong>${dict_language["Code Appartement"][language]} :</strong> ${digicodeAppartement}</p>
              
              <h2>üì∂ ${dict_language['Connexion WiFi'][language]}</h2>
              <p>üì° <strong>${dict_language['R√©seau'][language]} :</strong> ${wifi}</p>
              <p>
                üîè <strong>${dict_language['Mot de Passe'][language]} :</strong>
                <span id="wifiPassText">${wifiPass}</span>
                <button id="copyWifiBtn" class="copy-btn">üìã Copier</button>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>üí¨ ${dict_language['Messages Complets'][language]}</h2>
            <pre id="messageBlock">${message}</pre>
          </div>
        `;

        // Ajouter l'√©v√©nement de copie apr√®s avoir cr√©√© le HTML
        const copyBtn = document.getElementById("copyWifiBtn");
        const wifiPassEl = document.getElementById("wifiPassText");

        if (copyBtn && wifiPassEl) {
          copyBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(wifiPassEl.textContent.trim());
              copyBtn.textContent = "‚úÖ Copi√© !";
              setTimeout(() => {
                copyBtn.textContent = "üìã Copier";
              }, 2000);
            } catch (err) {
              console.error("Erreur de copie:", err);
              alert("‚ùå Erreur de copie");
            }
          });
        }

      } catch (error) {
        console.error("Erreur:", error);
        contentDiv.innerHTML = `<div class="error"><p>‚ùå ${dict_language['Erreur lors du chargement'][language]} : ${error.message}</p></div>`;
      }
    }

    // Lancer le script au chargement
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', main);
    } else {
      main();
    }
  </script>
</body>
</html>