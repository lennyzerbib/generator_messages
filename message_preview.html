<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Informations de s√©jour</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background:#0b0d12; color:#eef1f6; display:flex; min-height:100dvh; }
    .wrap { margin:auto; width:min(720px, 92vw); padding: 20px; }
    .card { background:#121722; border:1px solid #222938; border-radius:16px; padding:24px; box-shadow: 0 8px 24px rgba(0,0,0,.25); margin-bottom: 20px; }
    h1 { font-size:clamp(22px, 3.5vw, 28px); margin:0 0 16px; }
    h2 { font-size: 20px; margin: 20px 0 10px; color: #3e7aff; }
    p { margin: 8px 0; line-height: 1.6; }
    strong { color: #fff; }
    .copy-btn { 
      background: #3e7aff; 
      color: white; 
      border: none; 
      padding: 6px 12px;
      border-radius: 8px; 
      font-size: 14px; 
      cursor: pointer;
      margin-left: 10px;
    }
    .copy-btn:hover { background: #2d5fd9; }
    .copy-btn:active { transform: translateY(1px); }
    .error { color:#ff7b7b; padding: 20px; text-align: center; }
    .loading { color:#3e7aff; padding: 20px; text-align: center; }
    pre { 
      background: #0e121a; 
      padding: 16px; 
      border-radius: 8px; 
      overflow-x: auto;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
  </style>
</head>
<body>
  <main class="wrap">
    <div id="content">
      <div class="loading">
        <p>‚è≥ Chargement des informations...</p>
      </div>
    </div>
  </main>

  <script>
    function getCode() {
      // Essayer d'abord depuis les query params (?code=xxx)
      const urlParams = new URLSearchParams(window.location.search);
      let code = urlParams.get("code");
      
      // Si pas trouv√©, essayer depuis le path (/i/xxx)
      if (!code) {
        const pathMatch = window.location.pathname.match(/\/i\/([a-zA-Z0-9]{4,5})/);
        if (pathMatch) {
          code = pathMatch[1];
        }
      }
      
      return code || "";
    }

    async function main() {
      const code = getCode();
      const contentDiv = document.getElementById("content");
      
      if (!code) {
        contentDiv.innerHTML = '<div class="error"><p>‚ùå Erreur : code manquant dans l\'URL.</p></div>';
        return;
      }

      try {
        const resp = await fetch(`/api/get-link?code=${encodeURIComponent(code)}`);
        
        if (!resp.ok) {
          contentDiv.innerHTML = '<div class="error"><p>‚ùå Lien invalide ou expir√©.</p></div>';
          return;
        }

        const data = await resp.json();

        const digicodeImmeuble = data.digicodeImmeuble || "Non fourni";
        const digicodeAppartement = data.digicodeAppartement || "Non fourni";
        const wifi = data.wifi || "Non fourni";
        const wifiPass = data.wifiPass || "Non fourni";
        const message = data.message || "";

        contentDiv.innerHTML = `
          <div class="card">
            <h1>üìã Informations importantes</h1>
            
            <div id="importantCodes">
              <h2>üîê Codes d'acc√®s</h2>
              <p>üè¢ <strong>Code immeuble :</strong> ${digicodeImmeuble}</p>
              <p>üö™ <strong>Code appartement :</strong> ${digicodeAppartement}</p>
              
              <h2>üì∂ Connexion WiFi</h2>
              <p>üì° <strong>R√©seau :</strong> ${wifi}</p>
              <p>
                üîè <strong>Mot de passe :</strong>
                <span id="wifiPassText">${wifiPass}</span>
                <button id="copyWifiBtn" class="copy-btn">üìã Copier</button>
              </p>
            </div>
          </div>

          <div class="card">
            <h2>üí¨ Message complet</h2>
            <pre id="messageBlock">${message}</pre>
          </div>
        `;

        // Ajouter l'√©v√©nement de copie apr√®s avoir cr√©√© le HTML
        const copyBtn = document.getElementById("copyWifiBtn");
        const wifiPassEl = document.getElementById("wifiPassText");

        if (copyBtn && wifiPassEl) {
          copyBtn.addEventListener("click", async () => {
            try {
              await navigator.clipboard.writeText(wifiPassEl.textContent.trim());
              copyBtn.textContent = "‚úÖ Copi√© !";
              setTimeout(() => {
                copyBtn.textContent = "üìã Copier";
              }, 2000);
            } catch (err) {
              console.error("Erreur de copie:", err);
              alert("Erreur lors de la copie");
            }
          });
        }

      } catch (error) {
        console.error("Erreur:", error);
        contentDiv.innerHTML = `<div class="error"><p>‚ùå Erreur lors du chargement : ${error.message}</p></div>`;
      }
    }

    // Lancer le script au chargement
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', main);
    } else {
      main();
    }
  </script>
</body>
</html>