<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GÃ©nÃ©rateur de Messages</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background:#0b0d12; color:#eef1f6; display:flex; min-height:100dvh; }
    .wrap { margin:auto; width:min(720px, 92vw); }
    .card { background:#121722; border:1px solid #222938; border-radius:16px; padding:24px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    h1 { font-size:clamp(22px, 3.5vw, 28px); margin:0 0 8px; }
    p.hint { margin:0 0 18px; opacity:.85; }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input, select, button, .row { width:100%; }
    input, select { background:#0e121a; color:#eef1f6; border:1px solid #283042; border-radius:12px; padding:12px 14px; font-size:16px; outline:none; }
    input:focus, select:focus { border-color:#3e7aff; box-shadow:0 0 0 3px rgba(62,122,255,.2); }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .country { flex: 1.2; }
    .phone { flex: 2; }
    button {
      margin-top:16px; background:#3e7aff; color:white; border:none; padding:13px 16px;
      border-radius:12px; font-size:16px; font-weight:700; cursor:pointer;
    }
    button:active { transform: translateY(1px); }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .note { font-size:13px; opacity:.75; margin-top:10px; }
    .error { color:#ff7b7b; margin-top:10px; display:none; }
    footer { margin-top:16px; font-size:12px; opacity:.6; text-align:center; }

    /* Segmented button groups */
    .seg { display:flex; gap:8px; }
    .seg button {
      flex:1; margin-top:0; background:#0e121a; border:1px solid #283042; color:#eef1f6;
      padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer;
    }
    .seg button[aria-pressed="true"] { background:#3e7aff; color:#fff; border-color:#3e7aff; }
    .seg button:focus-visible { outline: 3px solid rgba(62,122,255,.5); outline-offset:2px; }

    /* Custom country code input */
    #customCodeWrap { display:none; }
    #customCode { letter-spacing: .5px; }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <h1>Messages : Villa Marina / Sephora</h1>
      <p class="hint">Choisissez la villa, l'appartement, le canal, puis saisissez le nom, les codes et le numÃ©ro. Nous ouvrirons l'app correspondante avec le message prÃ©rempli.</p>

      <form id="wappForm">
        <!-- Boutons dÃ©pendants -->
        <label>Villa</label>
        <div class="seg" id="villaGroup" role="group" aria-label="Choix de la villa">
          <button type="button" data-value="Villa Marina" aria-pressed="true">Villa Marina</button>
          <button type="button" data-value="Villa Sephora" aria-pressed="false">Villa Sephora</button>
        </div>

        <label style="margin-top:12px">Appartement</label>
        <select id="optionSelect" aria-label="Choix d'option"></select>

        <label style="margin-top:12px">Canal</label>
        <div class="seg" id="channelGroup" role="group" aria-label="Choix du canal">
          <button type="button" data-value="whatsapp" aria-pressed="true">WhatsApp</button>
          <button type="button" data-value="sms" aria-pressed="false">Message (SMS)</button>
        </div>

        <label for="language_message">Langue du message</label>
        <div class="row">
          <select id="language_message" class="language" aria-label="Choix de la langue">
            <option value="fr" selected>ğŸ‡«ğŸ‡· FranÃ§ais</option>
            <option value="en">ğŸ‡¬ğŸ‡§ English</option>
            <option value="es">ğŸ‡ªğŸ‡¸ EspaÃ±ol</option>
            <option value="it">ğŸ‡®ğŸ‡¹ Italiano</option>
            <option value="ru">ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
          </select>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid #222938" />

        <label for="name">Nom</label>
        <input id="name" name="name" type="text" placeholder="Ex. Lenny Zerbib" autocomplete="name" required />

        <label for="digicodeEntree">Digicode Immeuble</label>
        <input id="digicodeEntree" name="digicodeEntree" type="tel" inputmode="numeric" pattern="\d*" placeholder="Ex. 1234" />

        <label for="digicodeAppartement">Digicode Appartement</label>
        <input id="digicodeAppartement" name="digicodeAppartement" type="tel" inputmode="numeric" pattern="\d*" placeholder="Ex. 5678" />

        <label for="dateArrivee">Date d'arrivÃ©e</label>
        <input id="dateArrivee" name="dateArrivee" type="date" required />

        <label for="dateDepart">Date de dÃ©part</label>
        <input id="dateDepart" name="dateDepart" type="date" required />

        <label for="phone">NumÃ©ro de tÃ©lÃ©phone</label>
        <div class="row">
          <select id="country" class="country" aria-label="Indicatif pays">
            <option value="+33" selected>ğŸ‡«ğŸ‡· +33 (France)</option>
            <option value="+32">ğŸ‡§ğŸ‡ª +32 (Belgique)</option>
            <option value="+41">ğŸ‡¨ğŸ‡­ +41 (Suisse)</option>
            <option value="+39">ğŸ‡®ğŸ‡¹ +39 (Italie)</option>
            <option value="+34">ğŸ‡ªğŸ‡¸ +34 (Espagne)</option>
            <option value="+49">ğŸ‡©ğŸ‡ª +49 (Allemagne)</option>
            <option value="+44">ğŸ‡¬ğŸ‡§ +44 (R.-Uni)</option>
            <option value="+1">ğŸ‡ºğŸ‡¸ +1 (USA/Canada)</option>
            <option value="+212">ğŸ‡²ğŸ‡¦ +212 (Maroc)</option>
            <option value="+216">ğŸ‡¹ğŸ‡³ +216 (Tunisie)</option>
            <option value="+213">ğŸ‡©ğŸ‡¿ +213 (AlgÃ©rie)</option>
            <option value="+971">ğŸ‡¦ğŸ‡ª +971 (EAU)</option>
            <option value="+91">ğŸ‡®ğŸ‡³ +91 (Inde)</option>
            <option value="+81">ğŸ‡¯ğŸ‡µ +81 (Japon)</option>
            <option value="+61">ğŸ‡¦ğŸ‡º +61 (Australie)</option>
            <option value="__custom">âœï¸ Autre indicatifâ€¦</option>
          </select>
          <input id="phone" class="phone" name="phone" type="tel" inputmode="tel" placeholder="Ex. +33612345678 ou 0612345678" required />
        </div>

        <div id="customCodeWrap" class="row" aria-hidden="true">
          <input id="customCode" class="country" type="text" inputmode="tel" placeholder="Entrez un indicatif au format +XXX (ex. +380)" />
        </div>

        <div id="error" class="error" role="alert">Veuillez entrer un numÃ©ro valide.</div>

        <button type="submit">Envoyer</button>

        <div class="note">
          Si vous mettez un <strong>0 initial</strong> (ex. 06â€¦), nous utiliserons l'indicatif sÃ©lectionnÃ©.
          Vous pouvez aussi saisir un <strong>indicatif personnalisÃ©</strong> via Â« Autre indicatifâ€¦ Â».
        </div>
      </form>

      <footer>Fonctionne sur iPhone, Android, Windows, macOS &amp; WhatsApp Web.</footer>
    </div>
  </main>

  <!-- IMPORTANT: Importer le module messages.js AVANT le script principal -->
  <script src="message.js"></script>

  <script>
    const d_adresse = {
      'Villa Marina': '35 Avenue de Grasse, 06400 Cannes',
      'Villa Sephora': '27 Rue Meynadier, 06400 Cannes',
    };

    const dict_appartments = {
      'Little Havana': {
        villa: 'Villa Marina',
        etage: '1',
        orientation: 'Droite',
        wifi: 'Lan-1d',
        password_wifi: 'Siduzt-47@',
      },
      'Downtown': {
        villa: 'Villa Marina',
        etage: '2',
        orientation: 'Face',
        wifi: 'Lan-2f',
        password_wifi: 'Szkqjd-28@',
      },
      'Design District': {
        villa: 'Villa Marina',
        etage: '2',
        orientation: 'Droite',
        wifi: 'Lan-2d',
        password_wifi: 'Qkfhsu-95@',
      },
      'Coconut Grove Terrasse': {
        villa: 'Villa Marina',
        etage: '1',
        orientation: 'Face',
        wifi: 'Lan-1f',
        password_wifi: 'Dfkshr-98@',
      },
      'South Beach Terrasse': {
        villa: 'Villa Marina',
        etage: '3',
        orientation: 'Droite',
        wifi: 'Lan-3',
        password_wifi: 'Dbskgr-34@',
      },
      'Wynwood Loft': {
        villa: 'Villa Marina',
        etage: '0',
        orientation: 'RC',
        wifi: 'Lan-Rdc',
        password_wifi: 'Dghtod-45@',
      },
      'Villa Marina Building': {
        villa: 'Villa Marina',
        etage: '0',
        orientation: 'RC',
        wifi: 'Lan-Rdc',
        password_wifi: 'Dghtod-45@',
      },
      'Kos': {
        villa: 'Villa Sephora',
        etage: '1',
        orientation: 'Droite',
        wifi: 'Lan KOS',
        password_wifi: 'xI0$ufl~',
      },
      'Kea': {
        villa: 'Villa Sephora',
        etage: '2',
        orientation: 'Droite',
        wifi: 'Lan KEA',
        password_wifi: 'fbypl7q.',
      },
      'Samos': {
        villa: 'Villa Sephora',
        etage: '2',
        orientation: 'Milieu droit',
        wifi: 'Lan SAMOS',
        password_wifi: 'gyo4j!l|',
      },
      'Symi': {
        villa: 'Villa Sephora',
        etage: '2',
        orientation: 'Fond gauche',
        wifi: 'Lan SYMI',
        password_wifi: "9tav+h'o",
      },
      'Milos': {
        villa: 'Villa Sephora',
        etage: '2',
        orientation: 'Fond droite',
        wifi: 'Lan MILOS',
        password_wifi: 'e:yz7ceQ',
      },
      'Rhodes': {
        villa: 'Villa Sephora',
        etage: '2',
        orientation: '2Ã¨me gauche',
        wifi: 'Lan RHODES',
        password_wifi: '.$:qc+@q',
      },
      'Santorin': {
        villa: 'Villa Sephora',
        etage: '1',
        orientation: 'Gauche',
        wifi: 'Lan SANTORIN',
        password_wifi: 'ft;o?cm7',
      },
      'Corfou': {
        villa: 'Villa Sephora',
        etage: '2',
        orientation: 'Gauche',
        wifi: 'Lan COURFOU',
        password_wifi: 'tr+cn^t1',
      },
      'Mykonos': {
        villa: 'Villa Sephora',
        etage: '1',
        orientation: 'Face',
        wifi: 'Lan MYKONOS',
        password_wifi: 'Alo*LDJP',
      },
    };

    const d_suffix = {
      '0': { fr: '',   en: '',   es: '',  it: '',  ru: '' },
      '1': { fr: 'er', en: 'st', es: 'Âº', it: 'Âº', ru: 'Ğ¹' },
      '2': { fr: 'e',  en: 'nd', es: 'Âº', it: 'Âº', ru: 'Ğ¹' },
      '3': { fr: 'e',  en: 'rd', es: 'Âº', it: 'Âº', ru: 'Ğ¹' },
    };

    const ORIENTATION = {
      Droite: {fr: 'Droite', en: 'Right', es: 'Derecha', it: 'Destra', ru: 'Ğ¡Ğ¿Ñ€Ğ°Ğ²Ğ°' },
      Gauche: {fr: 'Gauche', en: 'Left', es: 'Izquierda', it: 'Sinistra', ru: 'Ğ¡Ğ»ĞµĞ²Ğ°' },
      Face: {fr: 'Face', en: 'Front', es: 'Frente', it: 'Fronte', ru: 'Ğ¡Ğ¿ĞµÑ€ĞµĞ´Ğ¸' },
      RC: {fr: 'RC', en: 'Ground Floor', es: 'Planta baja', it: 'Piano terra', ru: 'ĞŸĞµÑ€Ğ²Ñ‹Ğ¹ ÑÑ‚Ğ°Ğ¶'},
    };

    function getOrientation(orientation, lang) {
      return ORIENTATION[orientation]?.[lang] || orientation;
    }

    function getAppartmentsByVilla(villaName) {
      const result = [];
      for (let key in dict_appartments) {
        const value = dict_appartments[key];
        if (typeof value === 'object' && !Array.isArray(value)) {
          if (value.villa === villaName) {
            result.push(key);
          }
        }
      }
      return result;
    }

    function getAppartmentDetail(option, language) {
      const raw = dict_appartments[option]['etage'];
      const etage = (!raw || raw == 0) ? '' : raw;

      const orientation = getOrientation(dict_appartments[option]['orientation'], language) || '';
      const suffix = d_suffix[etage]?.[language] || '';

      if (language === 'ru' && etage !== '') {
        return `${etage}-${suffix} ${orientation}`.trim();
      }

      return `${etage}${suffix} ${orientation}`.trim();
    }

    function setPressed(btn, pressed) { btn.setAttribute('aria-pressed', pressed ? 'true' : 'false'); }
    function getPressedValue(group) {
      const active = group.querySelector('button[aria-pressed="true"]');
      return active ? active.dataset.value : null;
    }
    function makeSegmentedInteractive(group) {
      group.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !group.contains(btn)) return;
        group.querySelectorAll('button').forEach(x => setPressed(x, false));
        setPressed(btn, true);
      });
    }

    const villaGroup = document.getElementById('villaGroup');
    const optionSelect = document.getElementById('optionSelect');
    const channelGroup = document.getElementById('channelGroup');

    function refreshOptions() {
      const villa = getPressedValue(villaGroup);
      const list = villa === 'Villa Sephora' ? getAppartmentsByVilla('Villa Sephora') :
        getAppartmentsByVilla('Villa Marina Building').concat(getAppartmentsByVilla('Villa Marina'));
      optionSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'â€” Choisir â€”';
      optionSelect.appendChild(placeholder);
      list.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v; optionSelect.appendChild(opt);
      });
      optionSelect.selectedIndex = 0;
    }

    // init segmented groups & options
    makeSegmentedInteractive(villaGroup);
    makeSegmentedInteractive(channelGroup);
    refreshOptions();

    // Quand on change de villa, mettre Ã  jour la liste
    villaGroup.addEventListener('click', (e) => {
      if (e.target.closest('button')) refreshOptions();
    });

    // --- Phone normalization ---
    function normalizeNumber(raw, countryCode) {
      let s = (raw || '').trim();
      s = s.replace(/[^\d+]/g, '');
      if (s.startsWith('00')) s = '+' + s.slice(2);
      if (s.startsWith('+')) return s.replace(/\++/g, '+');
      if (s.startsWith('0')) return countryCode + s.slice(1);
      return countryCode + s;
    }
    function toE164Digits(s) { return (s || '').replace(/\D/g, ''); }

    // --- Custom country code handling ---
    const countrySel = document.getElementById('country');
    const customWrap = document.getElementById('customCodeWrap');
    const customInput = document.getElementById('customCode');

    function currentDialCode() {
      if (countrySel.value === '__custom') return (customInput.value || '').trim();
      return countrySel.value;
    }
    function validateDialCode(code) { return /^\+\d{1,4}$/.test(code); }

    countrySel.addEventListener('change', () => {
      const isCustom = countrySel.value === '__custom';
      customWrap.style.display = isCustom ? 'flex' : 'none';
      customWrap.setAttribute('aria-hidden', isCustom ? 'false' : 'true');
      if (isCustom) customInput.focus();
    });

    // --- Submit handling ---
    document.getElementById('wappForm').addEventListener('submit', async function (e) {
      e.preventDefault();
      const name = (document.getElementById('name').value || '').trim();
      const phoneRaw = document.getElementById('phone').value;
      const channel = getPressedValue(channelGroup) || 'whatsapp';
      const languageSelect = document.getElementById('language_message');
      const language = languageSelect.value || 'fr';

      let dial = currentDialCode();
      if (countrySel.value === '__custom') {
        if (!validateDialCode(dial)) {
          const errorEl = document.getElementById('error');
          errorEl.textContent = 'Veuillez saisir un indicatif personnalisÃ© valide (format +XXX).';
          errorEl.style.display = 'block';
          return;
        }
      } else if (!dial) {
        dial = '+33';
      }

      const normalized = normalizeNumber(phoneRaw, dial || '+33');
      const digits = toE164Digits(normalized);

      const errorEl = document.getElementById('error');
      if (!digits || digits.length < 8) {
        errorEl.textContent = 'Veuillez entrer un numÃ©ro valide.';
        errorEl.style.display = 'block';
        return;
      } else {
        errorEl.style.display = 'none';
      }

      const submitBtn = e.target.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = "â³ Envoi en cours...";

      try {
        const villa = getPressedValue(villaGroup) || '';
        const appartment = (document.getElementById('optionSelect').value || '');
        const detail_appart = getAppartmentDetail(appartment, language);
        const digicodeEntree = (document.getElementById('digicodeEntree').value || '');
        const digicodeAppartement = (document.getElementById('digicodeAppartement').value || '');
        const dateArrivee = document.getElementById('dateArrivee').value;
        const dateDepart = document.getElementById('dateDepart').value;
        const wifi = dict_appartments[appartment]?.wifi || '';
        const password_wifi = dict_appartments[appartment]?.password_wifi || '';

        // 1. GÃ©nÃ©rer le message COMPLET pour le stockage
        const messageComplet = getWelcomeMessage({
          language,
          name,
          villa,
          adresse: d_adresse[villa],
          appartment,
          detail_appart,
          digicodeEntree,
          digicodeAppartement,
          dateArrivee,
          dateDepart,
          wifi,
          password_wifi
        });
        
        const data = {
          message: messageComplet,
          digicodeImmeuble: digicodeEntree,
          digicodeAppartement,
          wifi,
          wifiPass: password_wifi
        };

        // 2. CrÃ©er le lien court
        const response = await fetch("/api/create-link", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || `Erreur HTTP: ${response.status}`);
        }

        const result = await response.json();
        
        if (!result.url) {
          throw new Error("URL non reÃ§ue du serveur");
        }
        
        const previewUrl = `${result.url.split('/i/')[0]}/message_preview.html?code=${result.code}`;

        const messageMini = getWelcomeMessageMini({
          language,
          name,
          villa,
          adresse: d_adresse[villa],
          appartment,
          detail_appart,
          digicodeEntree,
          digicodeAppartement,
          dateArrivee,
          dateDepart,
          wifi,
          password_wifi,
          previewUrl
        });

        // 4. Encoder et envoyer le message MINI
        const encoded = encodeURIComponent(messageMini);

        function openWhatsApp() {
          const waUrl = `https://wa.me/${digits}?text=${encoded}`;
          window.location.href = waUrl;
          setTimeout(() => {
            const deepLink = `whatsapp://send?phone=${digits}&text=${encoded}`;
            window.location.href = deepLink;
          }, 600);
        }
        
        function openSMS() {
          const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
          const smsUrl = isiOS ? `sms:${digits}&body=${encoded}` : `sms:${digits}?body=${encoded}`;
          window.location.href = smsUrl;
        }

        if (channel === 'sms') openSMS(); else openWhatsApp();

      } catch (error) {
        console.error("Erreur complÃ¨te:", error);
        errorEl.textContent = `Erreur lors de l'envoi : ${error.message}`;
        errorEl.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = originalText;
      }
    });
  </script>
</body>
</html>