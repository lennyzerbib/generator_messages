<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GÃ©nÃ©rateur de Messages</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
    body { margin: 0; background:#0b0d12; color:#eef1f6; display:flex; min-height:100dvh; }
    .wrap { margin:auto; width:min(720px, 92vw); }
    .card { background:#121722; border:1px solid #222938; border-radius:16px; padding:24px; box-shadow: 0 8px 24px rgba(0,0,0,.25); }
    h1 { font-size:clamp(22px, 3.5vw, 28px); margin:0 0 8px; }
    p.hint { margin:0 0 18px; opacity:.85; }
    label { display:block; margin:14px 0 6px; font-weight:600; }
    input, select, button, .row { width:100%; }
    input, select { background:#0e121a; color:#eef1f6; border:1px solid #283042; border-radius:12px; padding:12px 14px; font-size:16px; outline:none; }
    input:focus, select:focus { border-color:#3e7aff; box-shadow:0 0 0 3px rgba(62,122,255,.2); }
    .row { display:flex; gap:10px; }
    .row > * { flex:1; }
    .country { flex: 1.2; }
    .phone { flex: 2; }
    button {
      margin-top:16px; background:#3e7aff; color:white; border:none; padding:13px 16px;
      border-radius:12px; font-size:16px; font-weight:700; cursor:pointer;
    }
    button:active { transform: translateY(1px); }
    .note { font-size:13px; opacity:.75; margin-top:10px; }
    .error { color:#ff7b7b; margin-top:10px; display:none; }
    footer { margin-top:16px; font-size:12px; opacity:.6; text-align:center; }

    /* Segmented button groups */
    .seg { display:flex; gap:8px; }
    .seg button {
      flex:1; margin-top:0; background:#0e121a; border:1px solid #283042; color:#eef1f6;
      padding:10px 12px; border-radius:10px; font-weight:600; cursor:pointer;
    }
    .seg button[aria-pressed="true"] { background:#3e7aff; color:#fff; border-color:#3e7aff; }
    .seg button:focus-visible { outline: 3px solid rgba(62,122,255,.5); outline-offset:2px; }

    /* Custom country code input */
    #customCodeWrap { display:none; }
    #customCode { letter-spacing: .5px; }
  </style>
</head>
<body>
  <main class="wrap">
    <div class="card">
      <h1>Messages : Villa Marina / Sephora</h1>
      <p class="hint">Choisissez la villa, l'appartement, le canal, puis saisissez le nom, les codes et le numÃ©ro. Nous ouvrirons lâ€™app correspondante avec le message prÃ©rempli.</p>

      <form id="wappForm">
        <!-- Boutons dÃ©pendants -->
        <label>Villa</label>
        <div class="seg" id="villaGroup" role="group" aria-label="Choix de la villa">
          <button type="button" data-value="Villa Marina" aria-pressed="true">Villa Marina</button>
          <button type="button" data-value="Villa Sephora" aria-pressed="false">Villa Sephora</button>
        </div>

        <label style="margin-top:12px">Appartement</label>
        <select id="optionSelect" aria-label="Choix d'option"></select>

        <!-- Nouveau : choix du canal -->
        <label style="margin-top:12px">Canal</label>
        <div class="seg" id="channelGroup" role="group" aria-label="Choix du canal">
          <button type="button" data-value="whatsapp" aria-pressed="true">WhatsApp</button>
          <button type="button" data-value="sms" aria-pressed="false">Message (SMS)</button>
        </div>

        <hr style="margin:18px 0;border:none;border-top:1px solid #222938" />

        <label for="name">Nom</label>
        <input id="name" name="name" type="text" placeholder="Ex. Lenny Zerbib" autocomplete="name" required />

        <label for="digicodeEntree">Digicode Immeuble</label>
        <input id="digicodeEntree" name="digicodeEntree" type="tel" inputmode="numeric" pattern="\d*" placeholder="Ex. 1234" />

        <label for="digicodeAppartement">Digicode Appartement</label>
        <input id="digicodeAppartement" name="digicodeAppartement" type="tel" inputmode="numeric" pattern="\d*" placeholder="Ex. 5678" />

        <label for="dateArrivee">Date dâ€™arrivÃ©e</label>
        <input id="dateArrivee" name="dateArrivee" type="date" required />

        <label for="dateDepart">Date de dÃ©part</label>
        <input id="dateDepart" name="dateDepart" type="date" required />

        <label for="phone">NumÃ©ro de tÃ©lÃ©phone</label>
        <div class="row">
          <select id="country" class="country" aria-label="Indicatif pays">
            <!-- Quelques indicatifs courants, FR par dÃ©faut -->
            <option value="+33" selected>ğŸ‡«ğŸ‡· +33 (France)</option>
            <option value="+32">ğŸ‡§ğŸ‡ª +32 (Belgique)</option>
            <option value="+41">ğŸ‡¨ğŸ‡­ +41 (Suisse)</option>
            <option value="+39">ğŸ‡®ğŸ‡¹ +39 (Italie)</option>
            <option value="+34">ğŸ‡ªğŸ‡¸ +34 (Espagne)</option>
            <option value="+49">ğŸ‡©ğŸ‡ª +49 (Allemagne)</option>
            <option value="+44">ğŸ‡¬ğŸ‡§ +44 (R.-Uni)</option>
            <option value="+1">ğŸ‡ºğŸ‡¸ +1 (USA/Canada)</option>
            <option value="+212">ğŸ‡²ğŸ‡¦ +212 (Maroc)</option>
            <option value="+216">ğŸ‡¹ğŸ‡³ +216 (Tunisie)</option>
            <option value="+213">ğŸ‡©ğŸ‡¿ +213 (AlgÃ©rie)</option>
            <option value="+971">ğŸ‡¦ğŸ‡ª +971 (EAU)</option>
            <option value="+91">ğŸ‡®ğŸ‡³ +91 (Inde)</option>
            <option value="+81">ğŸ‡¯ğŸ‡µ +81 (Japon)</option>
            <option value="+61">ğŸ‡¦ğŸ‡º +61 (Australie)</option>
            <option value="__custom">âœï¸ Autre indicatifâ€¦</option>
          </select>
          <input id="phone" class="phone" name="phone" type="tel" inputmode="tel" placeholder="Ex. +33612345678 ou 0612345678" required />
        </div>

        <div id="customCodeWrap" class="row" aria-hidden="true">
          <input id="customCode" class="country" type="text" inputmode="tel" placeholder="Entrez un indicatif au format +XXX (ex. +380)" />
        </div>

        <div id="error" class="error" role="alert">Veuillez entrer un numÃ©ro valide.</div>

        <button type="submit">Envoyer</button>

        <div class="note">
          Si vous mettez un <strong>0 initial</strong> (ex. 06â€¦), nous utiliserons lâ€™indicatif sÃ©lectionnÃ©.
          Vous pouvez aussi saisir un <strong>indicatif personnalisÃ©</strong> via Â« Autre indicatifâ€¦ Â».
        </div>
      </form>

      <footer>Fonctionne sur iPhone, Android, Windows, macOS &amp; WhatsApp Web.</footer>
    </div>
  </main>

  <script>
    // --- Segmented helpers ---
    function setPressed(btn, pressed) { btn.setAttribute('aria-pressed', pressed ? 'true' : 'false'); }
    function getPressedValue(group) {
      const active = group.querySelector('button[aria-pressed="true"]');
      return active ? active.dataset.value : null;
    }
    function makeSegmentedInteractive(group) {
      group.addEventListener('click', (e) => {
        const btn = e.target.closest('button');
        if (!btn || !group.contains(btn)) return;
        group.querySelectorAll('button').forEach(x => setPressed(x, false));
        setPressed(btn, true);
      });
    }

    const villaGroup = document.getElementById('villaGroup');
    const optionSelect = document.getElementById('optionSelect');
    const channelGroup = document.getElementById('channelGroup');

    function refreshOptions() {
      const villa = getPressedValue(villaGroup);
      const list = villa === 'Villa Sephora' ? ['Kos', 'Kea', 'Samos', 'Symi', 'Milos', 'Rhodes', 'Santorin', 'Corfou', 'Mykonos'] :
        ['Little Havana', 'Downtown', 'Design District', 'Coconut Grove Terrasse', 'South Beach Terrasse', 'Wynwood Loft', 'Villa Marina Building'];
      optionSelect.innerHTML = '';
      const placeholder = document.createElement('option');
      placeholder.value = '';
      placeholder.textContent = 'â€” Choisir â€”';
      optionSelect.appendChild(placeholder);
      list.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v; opt.textContent = v; optionSelect.appendChild(opt);
      });
      optionSelect.selectedIndex = 0;
    }

    // init segmented groups & options
    makeSegmentedInteractive(villaGroup);
    makeSegmentedInteractive(channelGroup);
    refreshOptions();

    // Quand on change de villa, mettre Ã  jour la liste
    villaGroup.addEventListener('click', (e) => {
      if (e.target.closest('button')) refreshOptions();
    });

    // --- Phone normalization ---
    function normalizeNumber(raw, countryCode) {
      let s = (raw || '').trim();
      s = s.replace(/[^\d+]/g, '');
      if (s.startsWith('00')) s = '+' + s.slice(2);
      if (s.startsWith('+')) return s.replace(/\++/g, '+');
      if (s.startsWith('0')) return countryCode + s.slice(1);
      return countryCode + s;
    }
    function toE164Digits(s) { return (s || '').replace(/\D/g, ''); }

    // --- Custom country code handling ---
    const countrySel = document.getElementById('country');
    const customWrap = document.getElementById('customCodeWrap');
    const customInput = document.getElementById('customCode');

    function currentDialCode() {
      if (countrySel.value === '__custom') return (customInput.value || '').trim();
      return countrySel.value;
    }
    function validateDialCode(code) { return /^\+\d{1,4}$/.test(code); }

    countrySel.addEventListener('change', () => {
      const isCustom = countrySel.value === '__custom';
      customWrap.style.display = isCustom ? 'flex' : 'none';
      customWrap.setAttribute('aria-hidden', isCustom ? 'false' : 'true');
      if (isCustom) customInput.focus();
    });

    // --- Submit handling ---
    document.getElementById('wappForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const name = (document.getElementById('name').value || '').trim();
      const phoneRaw = document.getElementById('phone').value;
      const channel = getPressedValue(channelGroup) || 'whatsapp';

      let dial = currentDialCode();
      if (countrySel.value === '__custom') {
        if (!validateDialCode(dial)) {
          const errorEl = document.getElementById('error');
          errorEl.textContent = 'Veuillez saisir un indicatif personnalisÃ© valide (format +XXX).';
          errorEl.style.display = 'block';
          return;
        }
      } else if (!dial) {
        dial = '+33';
      }

      const normalized = normalizeNumber(phoneRaw, dial || '+33');
      const digits = toE164Digits(normalized);

      const errorEl = document.getElementById('error');
      if (!digits || digits.length < 8) {
        errorEl.textContent = 'Veuillez entrer un numÃ©ro valide.';
        errorEl.style.display = 'block';
        return;
      } else {
        errorEl.style.display = 'none';
      }

      const villa = getPressedValue(villaGroup) || '';
      const option = (document.getElementById('optionSelect').value || '');
      const digicodeEntree = (document.getElementById('digicodeEntree').value || '');
      const digicodeAppartement = (document.getElementById('digicodeAppartement').value || '');
      const dateArrivee = document.getElementById('dateArrivee').value;
      const dateDepart = document.getElementById('dateDepart').value;

      const base = new URL('.', location.href).href;          // URL du dossier courant
      const contratUrl = base + 'contrat.html';


      const message = 
        `Bonjour ${name},
Merci pour votre rÃ©servation dans la ${villa} (Appartement ${option}) du ${dateArrivee} au ${dateDepart}.

Immeuble : ${digicodeEntree}
Appartement : ${digicodeAppartement}

Voici votre document important Ã  conserver :
${contratUrl}

Bonne installation!`;

      const encoded = encodeURIComponent(message);

      function openWhatsApp() {
        const waUrl = `https://wa.me/${digits}?text=${encoded}`;
        window.location.href = waUrl;
        setTimeout(() => {
          const deepLink = `whatsapp://send?phone=${digits}&text=${encoded}`;
          window.location.href = deepLink;
        }, 600);
      }
      function openSMS() {
        const isiOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const smsUrl = isiOS ? `sms:${digits}&body=${encoded}` : `sms:${digits}?body=${encoded}`;
        window.location.href = smsUrl;
      }

      if (channel === 'sms') openSMS(); else openWhatsApp();
    });
  </script>
</body>
</html>
